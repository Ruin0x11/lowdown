<% if group_fields.size > 1 %>
  <!-- an outer layer, print group headers with proper level of indentation -->
  <% group_field_name = @report.group_fields[@report.groups.size - group_fields.size].titleize %>
  <% rows.sort_by {|k,v| row_sort(k)}.each do |group_name, row| %>
    <%= render 'group_header', :row => row, :group_fields => group_fields %>
    <%= render 'nested_rows', :rows => row, :group_fields => group_fields[1..-1] %>
    <%= render 'totals', :row=>row, :group_fields=>group_fields[1..-1], :short_name => short_group_name(row,group_fields), :group_field_name => group_field_name %>
  <% end %>
<% else %>  
  <!-- innermost layer, render the data -->
  <% rows.sort_by {|k,v| row_sort(k)}.each do |group_name, row| %>
    <%= render 'row', :row => row, :label => row.send(group_fields[0]) %>
  <% end %>
<% end %>

<% if group_fields.size == @report.group_fields.size %>
  <%= render 'totals', :row=>rows, :group_fields=>group_fields, :name => "All" %>
<% end %>
