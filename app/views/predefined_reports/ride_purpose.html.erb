<h1>Trip Purpose Report</h1>
<h2><%= describe_date_range(@query.start_date, @query.end_date) %></h2>
<table id="purpose-results">
  <thead>
    <tr>
      <th></th>
      <% for purpose in @trip_purposes %>
        <th class="data number"><%= purpose %></th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% @results.keys.sort.each do |county| %>
      <tr>
        <th class="contrast banner" colspan="<%= @trip_purposes.size + 1 %>"><%= county %> County</th>
      </tr>
  
      <% @results[county].keys.sort_by{|provider| provider.try(:name) || "Unspecified" }.each do |provider| %>
        <tr>
          <th scope="row"><%= provider.try :name || "Unspecified" %></th>
          <% for purpose in @trip_purposes %>
            <td class="number"><%= number_with_delimiter(@results[county][provider].by_purpose[purpose]) %></td>
          <% end %>
        </tr>
      <% end %>

      <!-- totals -->
      <tr>
        <th class="contrast" scope="row"><%= county %> County Total</th>
        <% total = RidePurposeRow.sum(@results[county]) %>
        <% for purpose in @trip_purposes %>
          <td class="number"><%= number_with_delimiter(total.by_purpose[purpose]) %></td>
        <% end %>
      </tr>

      <!-- percentages -->
      <tr>
        <% percentages = total.percentages %>
        <th scope="row">% of total county trips</th>
        <% for purpose in @trip_purposes %>
          <td class="number"><%= "%.2f\%" % percentages[purpose] %></td>
        <% end %>
      </tr>
    <% end %>
  
  </tbody>
  <tbody class="totals">
    <tr>
      <th class="contrast banner" colspan="<%= @trip_purposes.size + 1 %>">All Trips</th>
    </tr>
    <!-- grand totals -->
    <tr>
      <th class="contrast" scope="row">Grand Total</th>
      <% total = RidePurposeRow.sum(@results) %>
      <% for purpose in @trip_purposes %>
        <td class="number"><%= number_with_delimiter(total.by_purpose[purpose]) %></td>
      <% end %>
    </tr>

    <!-- grand total percentages -->
    <tr>
      <% percentages = total.percentages %>
      <th scope="row">% of total trips</th>
      <% for purpose in @trip_purposes %>
        <td class="number"><%= "%.2f\%" % percentages[purpose] %></td>
      <% end %>
    </tr>
  </tbody>
</table>
